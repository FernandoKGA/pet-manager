<div class="dashboard-container">
  <div class="expense-card">
    <h1>Minhas finanças</h1>
    <div class="d-flex justify-content-between align-items-center mb-4">
      <%= link_to "Voltar", user_path(@user), class: "btn btn-secondary-custom", data: { turbo: false } %>
      <button id="add-expense-btn" class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#expense-modal">
        Adicionar gasto
      </button>
    </div>
    <hr>
    <%= form_with(url: expenses_path, method: :get, data: { turbo_frame: "expenses_area", class: "mb-3" }) do %>
      <div>
        <%= label_tag :pet_id, "Pet", class: "form-label me-2" %>
        <%= select_tag :pet_id, 
                   options_from_collection_for_select(@pets, :id, :name, params[:pet_id]), 
                   include_blank: "Todos", 
                   onchange: "this.form.requestSubmit()",
                   class: "form-select d-inline-block w-auto me-4" %>
        <%= label_tag :period, "Período", class: "form-label me-2" %>
        <%= select_tag :period, 
                   options_for_select([["Última semana", "Última semana"], 
                                       ["Último mês", "Último mês"], 
                                       ["Último ano", "Último ano"]], 
                                       params[:period]), 
                   include_blank: "Todos", 
                   onchange: "this.form.requestSubmit()",
                   class: "form-select d-inline-block w-auto" %>
      </div>
    <% end %>
    <turbo-frame id="expenses_area">
      <div id="chart" style="height: 300px; margin-top: 1rem;">
        <%= pie_chart @chart_data, donut: true, height: "300px", library: { title: { text: "Gastos por Categoria" } } %>
      </div>
      <div class="mt-4">
        <h3>Histórico de Gastos</h3>
        <% if @expenses.present? %>
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Quantidade</th>
                <th>Categoria</th>
                <th>Pet</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody>
              <% @expenses.each do |expense| %>
                <tr>
                  <td><%= expense.date.strftime("%d/%m/%Y") %></td>
                  <td><%= expense.description %></td>
                  <td><%= number_to_currency(expense.amount, unit: "R$", separator: ",", delimiter: ".") %></td>
                  <td><%= expense.category %></td>
                  <td><%= expense.pet.name %></td>
                  <td class="text-end">
                    <%= link_to "Editar", edit_expense_path(expense), class: "btn btn-sm btn-outline-primary me-2", data: { turbo: false } %>
                    <%= button_to "Excluir",
                                  expense_path(expense),
                                  method: :delete,
                                  form: { data: { turbo_confirm: "Deseja excluir este gasto?" }, class: "d-inline" },
                                  class: "btn btn-sm btn-outline-danger" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <p class="text-center mt-3">Nenhum gasto encontrado para o período ou pet selecionado.</p>
        <% end %>
      </div>
    </turbo-frame>
    <% modal_expense = @expense || Expense.new %>
    <% modal_title = modal_expense.persisted? ? "Editar Gasto" : "Adicionar Gasto" %>
    <% modal_classes = ["modal", "fade"] %>
    <% modal_classes << "show d-block" if @open_modal %>
    <% modal_style = @open_modal ? "display: block;" : nil %>
    <div id="expense-modal" 
       class="<%= modal_classes.join(' ') %>" 
       <% if modal_style.present? %>style="<%= modal_style %>"<% end %>
       tabindex="-1" 
       data-controller="modal"
       data-modal-open-on-error-value="<%= modal_expense.errors.any? %>"
       data-modal-open-value="<%= @open_modal ? 'true' : 'false' %>"
       data-action="turbo:submit-end->modal#close">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title fs-5"><%= modal_title %></h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <%= render 'form', expense: modal_expense, pets: @pets, modal: true %>
          </div>
        </div>
      </div>
    </div>
    <% if @open_modal %>
      <div class="modal-backdrop fade show"></div>
    <% end %>
  </div>
</div>