<%= stylesheet_link_tag "dashboard", "data-turbo-track": "reload" %>

<div class="dashboard-container">

  <!-- Card de Boas-vindas -->
  <div class="welcome-card" style="display:flex; align-items:center; gap:16px;">
    <div class="welcome-avatar" style="flex:0 0 auto;">
      <% if current_user.photo_attached? %>
        <%= image_tag current_user.photo_data_uri,
            alt: "Foto do usu√°rio",
            style: "width:90px; height:90px; border-radius:50%; object-fit:cover; border:2px solid #ccc;" %>
      <% else %>
        <div style="
          width:90px; 
          height:90px; 
          border-radius:50%; 
          background:#eee; 
          border:2px solid #ccc; 
          display:flex; 
          align-items:center; 
          justify-content:center;
          font-size:48px;
        ">
          üë§
        </div>
      <% end %>
    </div>

    <div class="welcome-content" style="flex:1 1 auto; min-width:0;">
      <h1 class="welcome-title" style="margin:0 0 4px 0;">
        Bem-vindo, <%= current_user.first_name %> <%= current_user.last_name %>! üëã
      </h1>
      <p class="welcome-subtitle" style="margin:0 0 8px 0;">
        Estamos felizes em ter voc√™ AUqui üéâ
      </p>

      <div class="welcome-actions" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <%= link_to user_path(@user, notifications: 'open', anchor: 'notification-center-card'),
                    class: 'btn-secondary-custom notification-trigger',
                    data: { testid: 'open-notification-center' } do %>
          <span>üì¨ Central de notifica√ß√µes</span>
          <span class="badge bg-danger ms-2" data-testid="notification-indicator"><%= @unread_count %></span>
        <% end %>
        <%= button_to 'Editar cadastro',
                  edit_user_path(@user),
                  class: 'btn-primary-custom',
                  method: :get %>
        <%= link_to "Cadastrar pet", new_pet_path, class: "btn-secondary-custom" %>
        <%= link_to "Memorial", memorial_path, class: "btn-primary-custom", style: 'text-decoration: none;' %>
      </div>
    </div>
  </div>

  <%= render 'notification_center/panel',
             notifications: @notifications,
             unread_count: @unread_count,
             selected_notification: @selected_notification,
             panel_open: @notifications_panel_open,
             user: @user,
             custom_reminder_form: @custom_reminder_form,
             show_custom_reminder_modal: @show_custom_reminder_modal %>

  <!-- Se√ß√£o dos Pets -->
  <div class="pets-section">
    <div class="pets-header">
      <div>
        <h2 class="pets-title m-0">üêæ Meus Pets</h2>
        <p class="pets-subtitle">Aqui est√£o seus pets cadastrados</p>
      </div>
      <div class="pets-counter">
        <%= @pets.count %> <%= @pets.count == 1 ? 'pet' : 'pets' %>
      </div>
    </div>

    <div data-testid="active-pets-list">
      <% if @pets.present? %>
        <div class="pets-grid">
          <% @pets.each do |pet| %>
            <div class="pet-card">
              
              <!-- Decora√ß√£o -->
              <div class="pet-card-decoration"></div>
              
              <!-- Conte√∫do Principal -->
              <div class="pet-card-content">
                <div class="pet-avatar">
                  <% if pet.photo_attached? %>
                    <%= image_tag pet.photo_data_uri, alt: pet.name, style: "width:80px; height:80px; object-fit:cover; border-radius:50%;" %>
                  <% else %>
                    üê∂
                  <% end %>
                </div>
                
                <h3 class="pet-name">
                  <%= pet.name %>
                </h3>
                
                <p class="pet-info">
                  <%= pet.species %> ‚Ä¢ <%= pet.breed || 'SRD' %>
                  <% if pet.current_weight.present? %>
                    ‚Ä¢ <%= pet.current_weight %> kg
                  <% end %>
                </p>
              </div>

              <!-- Se√ß√£o de Medicamentos com Collapse -->
              <div class="pet-medications-section">
                <button class="medications-header medications-toggle" 
                        type="button"
                        data-bs-toggle="collapse" 
                        data-bs-target="#medications-<%= pet.id %>" 
                        aria-expanded="false" 
                        aria-controls="medications-<%= pet.id %>">
                  <div class="medications-header-content">
                    <h4 class="medications-title">üíä Medicamentos</h4>
                    <span class="medications-count">
                      <%= pet.medications.count %>
                    </span>
                  </div>
                  <span class="collapse-icon">‚ñº</span>
                </button>

                <div class="collapse" id="medications-<%= pet.id %>">
                  <% if pet.medications.any? %>
                    <div class="medications-list">
                      <% pet.medications.each do |medication| %>
                        <div class="medication-item">
                          <div class="flex-grow-1">
                            <p class="medication-name"><strong><%= medication.name %></strong></p>
                            <p class="medication-dosage"><%= medication.dosage %> ‚Ä¢ <%= medication.frequency %></p>
                            <% if medication.start_date.present? || medication.end_date.present? %>
                              <p class="medication-dates">
                                <% if medication.start_date.present? %>
                                  üìÖ In√≠cio: <%= medication.start_date.strftime("%d/%m/%Y") %>
                                <% end %>
                                <% if medication.end_date.present? %>
                                  <% if medication.start_date.present? %>
                                  <% end %>
                                  <% if medication.end_date.present? %>
                                <% css_class = medication.end_date >= Date.today ? "medication-date-active" : "medication-date-expired" %>
                                <% if medication.start_date.present? %>
                                <% end %>
                                <div class="mb-3"></div> 
                                üèÅ Fim:
                                <span class="<%= css_class %>">
                                  <%= medication.end_date.strftime("%d/%m/%Y") %>
                                </span>
                              <% end %>
                                <% end %>
                              </p>
                            <% end %>
                          </div>
                          <div class="medication-actions">
                            <%= link_to "‚úèÔ∏è", edit_pet_medication_path(pet, medication), class: "btn-small btn-edit", title: "Editar" %>
                            <%= link_to "üóëÔ∏è", pet_medication_path(pet, medication), 
                                class: "btn-small btn-delete", 
                                title: "Excluir",
                                data: { 
                                  turbo_method: :delete, 
                                  turbo_confirm: "Tem certeza que deseja excluir o medicamento #{medication.name}?" 
                                } %>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  <% else %>
                    <div class="medications-empty">
                      <p class="medications-empty-text">Nenhum medicamento registrado</p>
                    </div>
                  <% end %>
                  <%= link_to "+ Adicionar Medicamento", new_pet_medication_path(pet), class: "btn-add-medication" %>
                </div>
              </div>

              <!-- Bot√£o Editar -->
              <div class="pet-card-footer">
                <%= link_to "‚úèÔ∏è Editar", edit_pet_path(pet), class: "btn-edit" %>
                <%= link_to "Banho e Tosa", pet_baths_path(pet), class: "btn-edit" %>
                <%= link_to "Gr√°fico de peso", pet_weights_path(pet), class: "btn-edit" %>
                <%= link_to "Di√°rio", pet_diary_entries_path(pet), class: "btn-edit" %>
                <%= link_to "Vacinas", pet_vaccinations_path(pet), class: "btn-edit" %>
                <%= link_to "Consultas", pet_medical_appointments_path(pet), class: "btn-edit" %>
                <%= link_to "Desativar",
                            deactivate_pet_path(pet),
                            class: "btn-edit",
                            data: { turbo_method: :patch } %>
                <button type="button"
                        class="btn-destructive"
                        data-bs-toggle="modal"
                        data-bs-target="#deletePetModal-<%= pet.id %>">
                  Excluir
                </button>
              </div>
            </div>

            <div class="modal fade pet-delete-modal"
                 id="deletePetModal-<%= pet.id %>"
                 tabindex="-1"
                 aria-labelledby="deletePetModalLabel-<%= pet.id %>"
                 aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="deletePetModalLabel-<%= pet.id %>">Excluir Pet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                  </div>
                  <div class="modal-body">
                    <p>
                      Tem certeza que deseja excluir o Pet <strong><%= pet.name %></strong>?
                      Essa a√ß√£o remove todos os dados relacionados, incluindo banhos, vacinas e registros de sa√∫de.
                    </p>
                  </div>
                  <div class="modal-footer">
                    <button type="button"
                            class="btn-outline"
                            data-bs-dismiss="modal">
                      Cancelar
                    </button>
                    <%= button_to "Sim, excluir",
                                  pet_path(pet),
                                  method: :delete,
                                  class: "btn-destructive m-0", style: "min-width: 140px;" %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="empty-state">
          <div class="empty-state-icon">üêæ</div>
          <p class="empty-state-text">
            Voc√™ ainda n√£o cadastrou nenhum pet.
          </p>
          <p class="empty-state-subtext">
            Clique em "Cadastrar pet" para adicionar seu primeiro amiguinho!
          </p>
        </div>
      <% end %>
    </div>
  </div>

</div>
  <% if flash[:notice] %>
    <p style="color: green;"><%= flash[:notice] %></p>
  <% end %>
  <% if flash[:alert] %>
    <p style="color: red;"><%= flash[:alert] %></p>
  <% end %>