# spec/controllers/memorial_controller_spec.rb
require 'rails_helper'

RSpec.describe MemorialController, type: :controller do
  let(:user) { create(:user) }
  
  describe 'GET #index' do
    context 'when user is authenticated' do
      before do
        sign_in user
      end
      
      context 'when user has deceased pets' do
        let!(:deceased_pet1) { create(:pet, user: user, deceased: true, date_of_death: 2.days.ago) }
        let!(:deceased_pet2) { create(:pet, user: user, deceased: true, date_of_death: 5.days.ago) }
        let!(:living_pet) { create(:pet, user: user, deceased: false) }
        
        it 'returns http success' do
          get :index
          expect(response).to have_http_status(:success)
        end
        
        it 'renders the index template' do
          get :index
          expect(response).to render_template(:index)
        end
        
        it 'assigns deceased pets ordered by death date' do
          get :index
          expect(assigns(:deceased_pets)).to eq([deceased_pet1, deceased_pet2])
        end
        
        it 'does not include living pets' do
          get :index
          expect(assigns(:deceased_pets)).not_to include(living_pet)
        end
        
        it 'sets has_deceased_pets to true' do
          get :index
          expect(assigns(:has_deceased_pets)).to be true
        end
      end
      
      context 'when user has no deceased pets' do
        let!(:living_pet) { create(:pet, user: user, deceased: false) }
        
        it 'returns http success' do
          get :index
          expect(response).to have_http_status(:success)
        end
        
        it 'renders the index template' do
          get :index
          expect(response).to render_template(:index)
        end
        
        it 'assigns empty deceased pets collection' do
          get :index
          expect(assigns(:deceased_pets)).to be_empty
        end
        
        it 'sets has_deceased_pets to false' do
          get :index
          expect(assigns(:has_deceased_pets)).to be false
        end
      end
    end
    
    context 'when user is not authenticated' do
      it 'redirects to login page' do
        get :index
        expect(response).to redirect_to(login_path)
      end
      
      it 'does not assign deceased pets' do
        get :index
        expect(assigns(:deceased_pets)).to be_nil
      end
    end
  end
end